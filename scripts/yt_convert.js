const globalLoader=document.getElementById("globalLoader"),mainContent=document.getElementById("mainContent");setTimeout(()=>{globalLoader.classList.add("hidden"),document.body.style.overflow="auto",mainContent.classList.add("visible")},800);const POLL_MIN=2e3,POLL_MAX=5e3,POLL_STEP=500,MAX_ATTEMPTS=35;let state={polling:!1,attempts:0,converting:!1,downloadUrl:null,filename:"audio.mp3",youtubeId:null,url:null,title:"",mode:"mp3",quality:4,formatValue:1,pollDelay:2e3,aborted:!1};const els={rahulContainer:document.getElementById("rahul-container"),urlInput:document.getElementById("yt-url"),btnGo:document.getElementById("btn-go"),audioQuality:document.getElementById("audio-quality"),videoQuality:document.getElementById("video-quality"),optAudio:document.getElementById("opt-audio-quality"),optVideo:document.getElementById("opt-video-quality"),tabMp3:document.getElementById("tab-mp3"),tabMp4:document.getElementById("tab-mp4"),statusBox:document.getElementById("status-box"),statusLabel:document.getElementById("status-label"),infinityLoader:document.getElementById("infinity-loader"),downloadBtn:document.getElementById("download-btn"),preview:document.getElementById("video-preview"),thumb:document.getElementById("video-thumb"),title:document.getElementById("video-title"),channel:document.getElementById("video-channel"),mainCard:document.getElementById("main-card"),successView:document.getElementById("success-view"),monthText:document.getElementById("monthText"),goalProgress:document.getElementById("goalProgress"),goalPercent:document.getElementById("goalPercent")};function switchMode(t){state.mode=t,state.formatValue="mp4"===t?0:1,reset(),"mp3"===t?(els.tabMp3.classList.add("active"),els.tabMp4.classList.remove("active"),els.optAudio.style.display="",els.optVideo.style.display="none"):(els.tabMp3.classList.remove("active"),els.tabMp4.classList.add("active"),els.optAudio.style.display="none",els.optVideo.style.display="")}function extractYoutubeId(t){let e=t.match(/(?:v=|\/shorts\/|youtu\.be\/|embed\/)([a-zA-Z0-9_-]{11})/);return e?e[1]:null}function setStatus(t,e,l=!1){els.statusBox.classList.add("visible"),l?els.statusLabel.innerHTML=`
                    <img src="https://melamrahul.github.io/tools/right-tick.png"
                         alt="✓" style="width:32px;height:32px;vertical-align:middle;margin-right:1px;">
                    ${t}`:els.statusLabel.textContent=t,els.infinityLoader&&(els.infinityLoader.style.display=!1===e?"none":"block")}function reset(){state.polling=!1,state.attempts=0,state.converting=!1,state.downloadUrl=null,state.pollDelay=2e3,state.aborted=!0,els.infinityLoader&&(els.infinityLoader.style.display="none"),els.downloadBtn.classList.remove("visible"),els.downloadBtn.style.display="none",els.statusBox.classList.remove("visible"),els.urlInput.value=""}function makeFilename(t,e){if(!t)return"mp4"===e?"video.mp4":"audio.mp3";let l=t.replace(/[^\w\s\-]/g,"").replace(/\s+/g," ").trim().slice(0,80);return(l||("mp4"===e?"video":"audio"))+"."+e}function applyTitle(t){if(!t)return;let e="mp4"===state.mode?"mp4":"mp3";t!==state.title&&(state.title=t,state.filename=makeFilename(t,e));let l=els.title.textContent;l&&"—"!==l&&"Loading…"!==l||(els.title.textContent=t)}async function fetchMeta(t,e){els.thumb.src=`https://img.youtube.com/vi/${t}/mqdefault.jpg`,els.title.textContent="Loading…",els.channel.textContent="",els.preview.classList.add("visible");try{let l=await fetch(vner+"get_video_data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e}),signal:AbortSignal.timeout(8e3)});if(!l.ok)throw Error("Network error");let a=await l.json(),s=a?.title||a?.data?.title||"",n=a?.channel||a?.data?.channel||"";return s?(els.title.textContent=s,els.channel.textContent=n,applyTitle(s)):els.title.textContent="—",s}catch(o){return els.title.textContent="—",""}}async function callAPI(t){let e={youtube_id:state.youtubeId,url:state.url,title:state.title,quality:state.quality,formatValue:state.formatValue};t&&(e.action="check_only");try{let l=await fetch(vner+"r7q",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(3e4)});if(!l.ok)throw Error(`HTTP ${l.status}`);return await l.json()}catch(a){if("TimeoutError"===a.name)return{success:!1,status:"converting",message:"Still processing…"};return{success:!1,status:"converting",message:"Network issue, retrying…"}}}els.monthText.textContent=new Date().toLocaleString("default",{month:"long"}),updateGoal(),setInterval(updateGoal,6e4),els.btnGo.addEventListener("click",startFlow);const vner="https://rahul.serv00.net/apps/yt_convert/";async function startFlow(){let t=els.urlInput.value.trim();if(!t){alert("Please paste a YouTube link");return}let e=extractYoutubeId(t);if(!e){alert("Invalid YouTube URL");return}if(reset(),state.aborted=!1,els.rahulContainer.style.display="block",els.rahulContainer.classList.remove("fade-out"),els.mainCard.style.display="none",els.btnGo.disabled=!0,els.btnGo.textContent="…",state.youtubeId=e,state.url=t,state.title="",state.quality="mp3"===state.mode?parseInt(els.audioQuality.value):parseInt(els.videoQuality.value),state.attempts=0,state.pollDelay=2e3,els.preview.classList.remove("visible"),els.title.textContent="—",els.channel.textContent="",setStatus("Lightening fast converting..",!0),await Promise.race([fetchMeta(e,t),new Promise(t=>setTimeout(t,6e3))]),state.aborted)return;setStatus("Convertion engine started..",!0);let l=await callAPI(!1);state.aborted||handleResult(l,!1)}function handleResult(t,e){if(state.aborted)return;if(t.success&&"ready"===t.status){let l=t.download_link||t.server_path||"";if(!l){scheduleNextPoll();return}state.downloadUrl=l,(t.title||"").trim()&&applyTitle(t.title.trim()),setStatus("Ready to download!",!1,!0);let a="mp4"===state.mode?"mp4":"mp3";els.downloadBtn.style.display="block",setTimeout(()=>els.downloadBtn.classList.add("visible"),10),els.downloadBtn.textContent=`Download ${a.toUpperCase()}`,els.btnGo.disabled=!1,els.btnGo.textContent="Convert";return}if("error"===t.status){setStatus("Error: "+(t.message||"Something went wrong."),!1),els.btnGo.disabled=!1,els.btnGo.textContent="Convert";return}if(state.attempts>=35){setStatus("Timed out. Please try again.",!1),els.btnGo.disabled=!1,els.btnGo.textContent="Convert";return}let s=(t.message||"").toLowerCase(),n=s.includes("rate")||s.includes("session")||s.includes("busy")||s.includes("refresh"),o=!t.message||n?"Converting…":t.message;setStatus(o,!0),scheduleNextPoll()}function scheduleNextPoll(){state.attempts++;let t=Math.min(state.pollDelay,5e3);state.pollDelay=Math.min(state.pollDelay+500,5e3),setTimeout(async()=>{if(state.aborted)return;let t=await callAPI(!0);state.aborted||handleResult(t,!0)},t)}function triggerDownload(t,e,l,a){let s=vner+"_k3z?format="+encodeURIComponent(l)+"&title="+encodeURIComponent(a||"")+"&url="+encodeURIComponent(t)+"&_="+Date.now(),n=document.createElement("a");n.href=s,n.download=e,n.style.display="none",document.body.appendChild(n),n.click(),setTimeout(()=>document.body.removeChild(n),2e3)}function updateGoal(){fetch(vner+"total").then(t=>t.json()).then(t=>{let e=Math.min((parseFloat(t.total)||0)/50*100,100);els.goalProgress.style.width=e+"%",els.goalPercent.textContent=Math.floor(e)+"% of Goal"}).catch(()=>{els.goalPercent.textContent="0%"})}els.urlInput.addEventListener("keydown",t=>{"Enter"===t.key&&startFlow()}),els.downloadBtn.addEventListener("click",async()=>{if(state.youtubeId){setStatus("Preparing download…",!0);try{let t=await callAPI(!0),e=t.success&&(t.download_link||t.server_path)?t.download_link||t.server_path:state.downloadUrl;if(!e){setStatus("Link expired. Please convert again.",!1);return}state.downloadUrl=e,(t.title||"").trim()&&applyTitle(t.title.trim()),triggerDownload(e,state.filename,state.mode,state.title),els.rahulContainer.classList.add("fade-out"),setTimeout(()=>{els.rahulContainer.style.display="none",els.downloadBtn.style.display="none",els.successView.classList.add("visible"),window.scrollTo(0,0)},300)}catch(l){setStatus("Download failed. Try again.",!1)}}}),window.resetUI=function(){els.successView.classList.remove("visible"),els.mainCard.style.display="block",els.rahulContainer.style.display="block",els.rahulContainer.classList.remove("fade-out"),els.preview.classList.remove("visible"),els.thumb.src="",els.title.textContent="—",els.channel.textContent="",reset(),state.aborted=!0,els.urlInput.focus()};
